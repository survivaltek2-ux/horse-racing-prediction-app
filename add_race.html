<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Race - Horse Race Prediction App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-horse-head me-2"></i>
                Horse Race Predictor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="races.html">
                            <i class="fas fa-flag-checkered me-1"></i>Races
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="history.html">
                            <i class="fas fa-history me-1"></i>History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="stats.html">
                            <i class="fas fa-chart-bar me-1"></i>Statistics
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus me-1"></i>Add
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item active" href="add_race.html">
                                <i class="fas fa-flag-checkered me-1"></i>Add Race
                            </a></li>
                            <li><a class="dropdown-item" href="add_horse.html">
                                <i class="fas fa-horse me-1"></i>Add Horse
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="api_import.html">
                            <i class="fas fa-download me-1"></i>API Import
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-flag-checkered me-2"></i>Add New Race</h4>
                    </div>
                    <div class="card-body">
                        <form id="addRaceForm" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="raceName" class="form-label">Race Name *</label>
                                        <input type="text" class="form-control" id="raceName" required>
                                        <div class="invalid-feedback">
                                            Please provide a race name.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="track" class="form-label">Track *</label>
                                        <input type="text" class="form-control" id="track" required>
                                        <div class="invalid-feedback">
                                            Please provide a track name.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="raceDate" class="form-label">Race Date *</label>
                                        <input type="datetime-local" class="form-control" id="raceDate" required>
                                        <div class="invalid-feedback">
                                            Please provide a race date.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="distance" class="form-label">Distance (meters) *</label>
                                        <select class="form-select" id="distance" required>
                                            <option value="">Select distance</option>
                                            <option value="1000">1000m</option>
                                            <option value="1200">1200m</option>
                                            <option value="1400">1400m</option>
                                            <option value="1600">1600m</option>
                                            <option value="2000">2000m</option>
                                            <option value="2400">2400m</option>
                                        </select>
                                        <div class="invalid-feedback">
                                            Please select a distance.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="prizeMoney" class="form-label">Prize Money ($)</label>
                                        <input type="number" class="form-control" id="prizeMoney" min="0" step="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="raceType" class="form-label">Race Type</label>
                                        <select class="form-select" id="raceType">
                                            <option value="flat">Flat Race</option>
                                            <option value="hurdle">Hurdle Race</option>
                                            <option value="steeplechase">Steeplechase</option>
                                            <option value="maiden">Maiden Race</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="3"></textarea>
                            </div>

                            <!-- Horses Section -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5>Participating Horses</h5>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addHorseToRace()">
                                        <i class="fas fa-plus me-1"></i>Add Horse
                                    </button>
                                </div>
                                <div id="horsesContainer">
                                    <p class="text-muted">No horses added yet. Click "Add Horse" to add participants.</p>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="races.html" class="btn btn-secondary me-md-2">Cancel</a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Race
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Horse Modal -->
    <div class="modal fade" id="addHorseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Horse to Race</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addHorseToRaceForm">
                        <div class="mb-3">
                            <label for="horseName" class="form-label">Horse Name *</label>
                            <input type="text" class="form-control" id="horseName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="horseAge" class="form-label">Age *</label>
                                    <input type="number" class="form-control" id="horseAge" min="2" max="15" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="horseWeight" class="form-label">Weight (kg) *</label>
                                    <input type="number" class="form-control" id="horseWeight" min="300" max="600" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="jockey" class="form-label">Jockey</label>
                            <input type="text" class="form-control" id="jockey">
                        </div>
                        <div class="mb-3">
                            <label for="jockeyExperience" class="form-label">Jockey Experience (years)</label>
                            <input type="number" class="form-control" id="jockeyExperience" min="0" max="50">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveHorseToRace()">Add Horse</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/data-manager.js"></script>
    <script>
        let raceHorses = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date to today
            const now = new Date();
            const minDate = now.toISOString().slice(0, 16);
            document.getElementById('raceDate').min = minDate;

            // Setup form submission
            document.getElementById('addRaceForm').addEventListener('submit', handleFormSubmit);
        });

        function handleFormSubmit(event) {
            event.preventDefault();
            event.stopPropagation();

            const form = event.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const raceData = {
                name: document.getElementById('raceName').value,
                track: document.getElementById('track').value,
                date: document.getElementById('raceDate').value,
                distance: parseInt(document.getElementById('distance').value),
                prize_money: parseFloat(document.getElementById('prizeMoney').value) || 0,
                race_type: document.getElementById('raceType').value,
                description: document.getElementById('description').value,
                horses: raceHorses
            };

            try {
                const savedRace = DataManager.addRace(raceData);
                alert('Race added successfully!');
                window.location.href = 'races.html';
            } catch (error) {
                alert('Error adding race: ' + error.message);
            }
        }

        function addHorseToRace() {
            // Clear the form
            document.getElementById('addHorseToRaceForm').reset();
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('addHorseModal')).show();
        }

        function saveHorseToRace() {
            const horseName = document.getElementById('horseName').value;
            const horseAge = parseInt(document.getElementById('horseAge').value);
            const horseWeight = parseInt(document.getElementById('horseWeight').value);
            const jockey = document.getElementById('jockey').value;
            const jockeyExperience = parseInt(document.getElementById('jockeyExperience').value) || 0;

            if (!horseName || !horseAge || !horseWeight) {
                alert('Please fill in all required fields.');
                return;
            }

            const horse = {
                id: Date.now(), // Temporary ID
                name: horseName,
                age: horseAge,
                weight: horseWeight,
                jockey: jockey,
                jockey_experience: jockeyExperience
            };

            raceHorses.push(horse);
            updateHorsesDisplay();

            // Hide the modal
            bootstrap.Modal.getInstance(document.getElementById('addHorseModal')).hide();
        }

        function updateHorsesDisplay() {
            const container = document.getElementById('horsesContainer');
            
            if (raceHorses.length === 0) {
                container.innerHTML = '<p class="text-muted">No horses added yet. Click "Add Horse" to add participants.</p>';
                return;
            }

            const horsesHtml = raceHorses.map((horse, index) => `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${horse.name}</strong>
                                <small class="text-muted ms-2">
                                    Age: ${horse.age} | Weight: ${horse.weight}kg
                                    ${horse.jockey ? ` | Jockey: ${horse.jockey}` : ''}
                                </small>
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeHorse(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = horsesHtml;
        }

        function removeHorse(index) {
            raceHorses.splice(index, 1);
            updateHorsesDisplay();
        }
    </script>
</body>
</html>