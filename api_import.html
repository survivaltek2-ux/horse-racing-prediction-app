<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Import - Horse Race Prediction App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-horse-head me-2"></i>
                Horse Race Predictor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="races.html">
                            <i class="fas fa-flag-checkered me-1"></i>Races
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="history.html">
                            <i class="fas fa-history me-1"></i>History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="stats.html">
                            <i class="fas fa-chart-bar me-1"></i>Statistics
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus me-1"></i>Add
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="add_race.html">
                                <i class="fas fa-flag-checkered me-1"></i>Add Race
                            </a></li>
                            <li><a class="dropdown-item" href="add_horse.html">
                                <i class="fas fa-horse me-1"></i>Add Horse
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="api_import.html">
                            <i class="fas fa-download me-1"></i>API Import
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-download me-2"></i>Import Races from API</h4>
                    </div>
                    <div class="card-body">
                        <!-- API Provider Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="apiProvider" class="form-label">Select API Provider</label>
                                <select class="form-select" id="apiProvider">
                                    <option value="">Choose a provider...</option>
                                    <option value="theracingapi">TheRacingAPI</option>
                                    <option value="horseracingapi">Horse Racing API</option>
                                    <option value="sample">Sample API (Demo)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Connection Status</label>
                                <div>
                                    <button type="button" class="btn btn-outline-primary" id="testConnectionBtn" disabled>
                                        <i class="fas fa-plug me-2"></i>Test Connection
                                    </button>
                                    <span id="connectionStatus" class="ms-2"></span>
                                </div>
                            </div>
                        </div>

                        <!-- API Configuration -->
                        <div id="apiConfig" style="display: none;">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6>API Configuration</h6>
                                </div>
                                <div class="card-body">
                                    <div id="configFields">
                                        <!-- Dynamic configuration fields will be inserted here -->
                                    </div>
                                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Security Notice:</strong> For security reasons, credentials are not saved in the browser. 
                        Please enter your API credentials each time you use this feature.
                    </div>
                    <div class="mt-2">
                        <button type="button" id="testConnectionBtn" class="btn btn-outline-primary" disabled>
                            <i class="fas fa-plug me-2"></i>Test Connection
                        </button>
                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fetch Options -->
                        <div id="fetchOptions" style="display: none;">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6>Fetch Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dateFrom" class="form-label">From Date</label>
                                                <input type="date" class="form-control" id="dateFrom">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dateTo" class="form-label">To Date</label>
                                                <input type="date" class="form-control" id="dateTo">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="trackFilter" class="form-label">Track (Optional)</label>
                                                <input type="text" class="form-control" id="trackFilter" placeholder="Leave empty for all tracks">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="maxRaces" class="form-label">Maximum Races</label>
                                                <select class="form-select" id="maxRaces">
                                                    <option value="10">10 races</option>
                                                    <option value="25">25 races</option>
                                                    <option value="50">50 races</option>
                                                    <option value="100">100 races</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Fetch Button -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
                                <button type="button" class="btn btn-primary btn-lg" id="fetchRacesBtn">
                                    <i class="fas fa-download me-2"></i>Fetch Races
                                </button>
                            </div>
                        </div>

                        <!-- Results -->
                        <div id="fetchResults" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Fetch Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="resultsContent">
                                        <!-- Results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loading Indicator -->
                        <div id="loadingIndicator" style="display: none;">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Fetching races from API...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/data-manager.js"></script>
    <script>
        const apiProviders = {
            theracingapi: {
                name: 'TheRacingAPI',
                auth_type: 'basic',
                username_required: true,
                password_required: true,
                fields: [
                    { name: 'username', label: 'Username', type: 'text', required: true },
                    { name: 'password', label: 'Password', type: 'password', required: true }
                ]
            },
            horseracingapi: {
                name: 'Horse Racing API',
                auth_type: 'api_key',
                api_key_required: true,
                fields: [
                    { name: 'api_key', label: 'API Key', type: 'text', required: true }
                ]
            },
            sample: {
                name: 'Sample API (Demo)',
                auth_type: 'none',
                fields: []
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setDefaultDates();
        });

        function setupEventListeners() {
            document.getElementById('apiProvider').addEventListener('change', handleProviderChange);
            document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
            document.getElementById('fetchRacesBtn').addEventListener('click', fetchRaces);
        }

        function setDefaultDates() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            document.getElementById('dateFrom').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('dateTo').value = nextWeek.toISOString().split('T')[0];
        }

        function handleProviderChange() {
            const provider = document.getElementById('apiProvider').value;
            const testBtn = document.getElementById('testConnectionBtn');
            const apiConfig = document.getElementById('apiConfig');
            const fetchOptions = document.getElementById('fetchOptions');

            if (!provider) {
                testBtn.disabled = true;
                apiConfig.style.display = 'none';
                fetchOptions.style.display = 'none';
                return;
            }

            const providerConfig = apiProviders[provider];
            if (providerConfig) {
                setupConfigFields(providerConfig);
                testBtn.disabled = false;
                apiConfig.style.display = providerConfig.fields.length > 0 ? 'block' : 'none';
                fetchOptions.style.display = 'block';
                
                //
            }
        }

        function setupConfigFields(config) {
            const container = document.getElementById('configFields');
            
            if (config.fields.length === 0) {
                container.innerHTML = '<p class="text-muted">No configuration required for this provider.</p>';
                return;
            }

            const fieldsHtml = config.fields.map(field => `
                <div class="mb-3">
                    <label for="${field.name}" class="form-label">
                        ${field.label} ${field.required ? '*' : ''}
                    </label>
                    <input type="${field.type}" class="form-control" id="${field.name}" 
                           ${field.required ? 'required' : ''}>
                </div>
            `).join('');

            container.innerHTML = fieldsHtml;
        }

        async function testConnection() {
            const provider = document.getElementById('apiProvider').value;
            const statusElement = document.getElementById('connectionStatus');
            
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i> Testing...';

            try {
                // Simulate API connection test
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // For demo purposes, always return success
                statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Connected';
            } catch (error) {
                statusElement.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Connection failed';
            }
        }

        async function fetchRaces() {
            const provider = document.getElementById('apiProvider').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const maxRaces = parseInt(document.getElementById('maxRaces').value);

            if (!provider) {
                alert('Please select an API provider.');
                return;
            }

            showLoading(true);
            hideResults();

            try {
                // Simulate API call
                const result = await DataManager.fetchRacesFromAPI(provider, {
                    dateFrom,
                    dateTo,
                    maxRaces
                });

                if (result.success) {
                    displayResults(result.races);
                    
                    // Import the races
                    const importedCount = DataManager.importRacesFromAPI(result.races);
                    
                    showSuccess(`Successfully imported ${importedCount} races!`);
                } else {
                    showError('Failed to fetch races from API.');
                }
            } catch (error) {
                showError('Error fetching races: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayResults(races) {
            const container = document.getElementById('resultsContent');
            
            if (races.length === 0) {
                container.innerHTML = '<p class="text-muted">No races found for the specified criteria.</p>';
            } else {
                const racesHtml = races.map(race => `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${race.name}</strong>
                                    <small class="text-muted ms-2">
                                        ${race.track} | ${formatDate(race.date)} | ${race.distance}m
                                    </small>
                                </div>
                                <span class="badge bg-primary">${race.horses ? race.horses.length : 0} horses</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Found ${races.length} races. These will be imported into your local database.
                    </div>
                    ${racesHtml}
                `;
            }

            document.getElementById('fetchResults').style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('fetchRacesBtn').disabled = show;
        }

        function hideResults() {
            document.getElementById('fetchResults').style.display = 'none';
        }

        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alert, document.querySelector('.card-body').firstChild);
        }

        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alert, document.querySelector('.card-body').firstChild);
        }

        // Security Note: Credential storage has been removed for security reasons
        // Users must enter credentials each time they use the API import feature
    </script>
</body>
</html>